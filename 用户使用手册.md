# ComfyUI_KuAi_Power 用户使用手册

> 适用项目：`ComfyUI/custom_nodes/ComfyUI_KuAi_Power`
> 面向对象：插件使用者、工作流搭建者、日常维护者

---

## 1. 插件简介

ComfyUI_KuAi_Power 是面向中文用户的 ComfyUI 扩展，提供：

- 视频生成：Sora2 / Veo3.1 / Grok
- 图像生成：Nano Banana / Gemini
- 理解能力：Gemini 图片理解、Gemini 视频理解
- 工具节点：图片上传、音频上传、OCR、视频下载、CSV 批处理、文本显示等

---

## 2. 安装与启动

### 2.1 安装依赖

```bash
pip install -r requirements.txt
```

### 2.2 配置 API Key

二选一：

```bash
export KUAI_API_KEY=你的key
```

或在项目根目录创建 `.env`：

```env
KUAI_API_KEY=你的key
```

### 2.3 诊断

```bash
python diagnose.py
```

### 2.4 重启 ComfyUI

每次修改节点代码后都需要重启 ComfyUI（无热更新）。

---

## 3. 新增/重点能力说明

### 3.1 Gemini 图片理解（🔍 Gemini 图片理解）

- 输入：`IMAGE`、提示词、模型、API Key
- 输出：`STRING`（完整理解文本）
- 模型下拉支持：
  - `gemini-3.1-pro-preview`
  - `gemini-3-pro-preview`
  - `gemini-3-flash-preview`
  - `gemini-3-pro-preview-thinking`
  - `gemini-2.5-pro`
  - `gemini-2.5-flash`
- `custom_model`：可覆盖下拉模型
- `api_base` 默认：`https://ai.kegeai.top`
- `timeout` 最大：`6000` 秒

### 3.2 Gemini 视频理解（🎬 Gemini 视频理解）

- 已支持与 ComfyUI `LoadVideo` 节点直连
- 推荐输入方式：`VIDEO`（来自“加载视频”节点）
- 兼容旧输入方式：`video_path`（字符串路径）
- 选择优先级：`video` 输入 > `video_path`
- `timeout` 最大：`6000` 秒

### 3.3 ShowText 文本显示节点（📄 显示文本）

- 用于在工作流末端显示字符串结果
- 已修复显示兼容性，能稳定显示完整理解文本

---

## 4. 推荐工作流搭建

### 4.1 Gemini 图片理解工作流

```text
LoadImage -> GeminiImageUnderstanding -> ShowText
```

示例文件：
- `workflows/gemini_image_understanding_workflow.json`

### 4.2 Gemini 视频理解工作流

```text
LoadVideo -> GeminiVideoUnderstanding(video) -> ShowText
```

示例文件：
- `workflows/gemini_video_understanding_workflow.json`

---

## 5. Grok 模型使用说明（近期增强）

- 已恢复 `custom_model` 覆盖能力
- 已补齐 15 秒模型选项
- 旧工作流对 `custom_model` 的使用方式继续兼容

---

## 6. 常见问题（FAQ）

### Q1：工作流导入后提示缺少插件？
- 请先重启 ComfyUI，确认本插件已完整加载。
- 当前 Gemini 示例工作流依赖本仓库内置 `ShowText` 节点，无需额外第三方文本节点。

### Q2：为什么控制台显示“结果长度”，但看不到完整文本？
- “结果长度”是调试日志，不是最终输出。
- 请在 `ShowText` 节点查看完整结果。
- 若仍看不到，重启 ComfyUI 后重新执行工作流。

### Q3：Gemini 视频理解怎么接视频？
- 推荐直接连接 ComfyUI 的 `LoadVideo` 输出到 `GeminiVideoUnderstanding.video`。
- 若历史工作流仍使用 `video_path`，也可继续使用。

### Q4：请求容易超时怎么办？
- 将图片/视频理解节点的 `timeout` 调高（最大 6000 秒）。
- 网络较慢时建议提高超时时间并简化提示词。

---

## 7. 维护与回归建议

每次升级后建议执行：

```bash
python test/test_gemini_understanding.py
python test/test_show_text.py
python -m py_compile nodes/Gemini/gemini_understanding.py
```

并手动验证：

1. `LoadImage -> GeminiImageUnderstanding -> ShowText`
2. `LoadVideo -> GeminiVideoUnderstanding -> ShowText`
3. Grok 的 `custom_model` 覆盖链路

---

## 8. 关键文档索引

- 变更与经验沉淀：`todo.md`
- Gemini 节点详细说明：`docs/GEMINI_UNDERSTANDING_GUIDE.md`
- Gemini API 参考：`docs/gemini_api_pic-video.md`
- 其他能力文档：`docs/` 目录

---

（完）
